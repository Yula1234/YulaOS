#include <arch/i386/idt.h>

#include <hal/io.h>
#include <hal/irq.h>

#include "mouse.h"

int mouse_x = 512, mouse_y = 384;
int mouse_buttons = 0;

static uint8_t mouse_cycle = 0;
static uint8_t mouse_byte[3];

extern uint32_t fb_width;
extern uint32_t fb_height;

void mouse_wait(uint8_t type) {
    uint32_t timeout = 100000;
    if (type == 0) {
        while (timeout--) if ((inb(0x64) & 1) == 1) return;
    } else {
        while (timeout--) if ((inb(0x64) & 2) == 0) return;
    }
}

uint32_t mouse_cursor_classic[144] = {
    0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0xFFFFFF, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0xFFFFFF, 0xFFFFFF, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0xFFFFFF, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0xFFFFFF, 0xFFFFFF, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0xFFFFFF, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0x000000, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
    0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF,
};

uint32_t icon_terminal[256] = {
    0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0x00FF00, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0x00FF00, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x00FF00, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0x00FF00, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0x00FF00, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x00FF00, 0x00FF00, 0x00FF00, 0x00FF00, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D
};

uint32_t icon_monitor[256] = {
    0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x007ACC, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x007ACC, 0x007ACC, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0x007ACC, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x007ACC, 0xFF00FF, 0xFF00FF, 0x007ACC, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0x007ACC, 0x007ACC, 0xFF00FF, 0x007ACC, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x007ACC, 0x007ACC, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0x007ACC, 0x007ACC, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x007ACC, 0x007ACC, 0x007ACC, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0xFF00FF, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x2D2D2D,
    0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D, 0x2D2D2D
};

void mouse_write(uint8_t a) {
    mouse_wait(1);
    outb(0x64, 0xD4);
    mouse_wait(1);
    outb(0x60, a);
}

uint8_t mouse_read() {
    mouse_wait(0);
    return inb(0x60);
}

void mouse_irq_handler(registers_t* regs) {
    (void)regs;
    uint8_t status = inb(0x64);
    
    if (!(status & 0x01)) return;

    uint8_t data = inb(0x60);

    if (status & 0x20) {
        mouse_process_byte(data);
    }
}


void mouse_init() {
    uint8_t status;

    mouse_wait(1);
    outb(0x64, 0xA8);

    mouse_wait(1);
    outb(0x64, 0x20);
    status = mouse_read() | 2;
    status &= ~0x20;          

    mouse_wait(1);
    outb(0x64, 0x60);
    mouse_wait(1);
    outb(0x60, status);

    mouse_write(0xF6);
    mouse_read();     

    mouse_write(0xF4);
    mouse_read();     

    irq_install_handler(12, mouse_irq_handler);

    outb(0xA1, inb(0xA1) & ~(1 << 4)); // Slave: IRQ 12
    outb(0x21, inb(0x21) & ~(1 << 2)); // Master: Cascade
}

extern void wake_up_gui();

void mouse_process_byte(uint8_t data) {
    if (mouse_cycle == 0 && !(data & 0x08)) return;

    mouse_byte[mouse_cycle++] = data;

    if (mouse_cycle == 3) {
        mouse_cycle = 0;
        
        if (mouse_byte[0] & 0x80 || mouse_byte[0] & 0x40) return;

        int32_t rel_x = (int8_t)mouse_byte[1];
        int32_t rel_y = (int8_t)mouse_byte[2];

        mouse_buttons = mouse_byte[0] & 0x07;

        mouse_x += rel_x;
        mouse_y -= rel_y;

        if (mouse_x < 0) mouse_x = 0;
        if (mouse_y < 0) mouse_y = 0;
        if (mouse_x >= (int)fb_width)  mouse_x = fb_width - 1;
        if (mouse_y >= (int)fb_height) mouse_y = fb_height - 1;
        wake_up_gui();
    }
}